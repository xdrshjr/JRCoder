# 00-总体架构设计

## 1. 系统概述

OpenJRAgent 是一个基于 TypeScript 的自动化编程 Agent 系统，通过智能规划、工具调用和反思循环实现复杂编程任务的自动化执行。

### 核心能力
- **智能任务规划**: 自动判断任务复杂度，生成执行计划
- **工具化执行**: 标准化工具接口，支持代码查询、文件操作、Shell 执行
- **反思优化**: 执行后自动评估，迭代改进
- **多模型支持**: Planner/Executor/Reflector 可配置不同 LLM
- **用户交互**: 关键节点暂停确认，保证可控性

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         CLI Layer                            │
│  (Commander.js + Inquirer.js + Chalk + Ora)                 │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      Agent Core Layer                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Planner  │→ │ Executor │→ │Reflector │→ │UserConfirm│  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                         ↓                                    │
│                  ┌──────────────┐                           │
│                  │ State Manager│                           │
│                  └──────────────┘                           │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      Tool System Layer                       │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐  │
│  │CodeQuery│ │FileOps │ │Snippet │ │ Shell  │ │AskUser │  │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘  │
│                  Tool Manager + Validator                    │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │LLM Client│  │  Logger  │  │  Config  │  │  Storage │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 3. 模块划分

### 3.1 核心模块
```
src/
├── core/
│   ├── agent.ts           # Agent 主循环控制器
│   ├── planner.ts         # 任务规划器
│   ├── executor.ts        # 任务执行器
│   ├── reflector.ts       # 反思评估器
│   └── state.ts           # 状态管理器
```

### 3.2 工具模块
```
src/
├── tools/
│   ├── base.ts            # 工具基类和接口
│   ├── manager.ts         # 工具管理器
│   ├── code-query.ts      # 代码查询工具
│   ├── file-ops.ts        # 文件操作工具
│   ├── snippet.ts         # 代码片段工具
│   ├── shell.ts           # Shell 执行工具
│   ├── ask-user.ts        # 用户交互工具
│   └── validator.ts       # 工具调用验证器
```

### 3.3 基础设施模块
```
src/
├── llm/
│   ├── client.ts          # LLM 客户端抽象
│   ├── openai.ts          # OpenAI 适配器
│   ├── anthropic.ts       # Anthropic 适配器
│   └── types.ts           # LLM 类型定义
├── logger/
│   ├── logger.ts          # 日志系统
│   ├── formatters.ts      # 日志格式化
│   └── transports.ts      # 日志输出
├── config/
│   ├── loader.ts          # 配置加载器
│   ├── validator.ts       # 配置验证器
│   └── schema.ts          # 配置模式定义
└── storage/
    ├── memory.ts          # 内存存储
    └── file.ts            # 文件存储
```

### 3.4 CLI 模块
```
src/
├── cli/
│   ├── index.ts           # CLI 入口
│   ├── commands.ts        # 命令定义
│   ├── prompts.ts         # 交互提示
│   └── display.ts         # 界面渲染
```

## 4. 技术栈

### 4.1 核心依赖
| 技术 | 用途 | 版本 |
|------|------|------|
| TypeScript | 开发语言 | ^5.0.0 |
| Node.js | 运行时 | >=18.0.0 |
| Commander.js | CLI 框架 | ^11.0.0 |
| Inquirer.js | 交互提示 | ^9.0.0 |
| Winston | 日志系统 | ^3.11.0 |
| Chalk | 终端着色 | ^5.3.0 |
| Ora | 加载动画 | ^7.0.0 |

### 4.2 LLM SDK
- OpenAI SDK: `openai@^4.0.0`
- Anthropic SDK: `@anthropic-ai/sdk@^0.17.0`

### 4.3 开发工具
- ESLint + Prettier: 代码规范
- Jest: 单元测试
- TSDoc: 文档生成

## 5. 目录结构

```
OpenJRAgent/
├── src/                   # 源代码
│   ├── core/             # 核心模块
│   ├── tools/            # 工具系统
│   ├── llm/              # LLM 客户端
│   ├── logger/           # 日志系统
│   ├── config/           # 配置系统
│   ├── storage/          # 存储系统
│   ├── cli/              # CLI 界面
│   └── index.ts          # 入口文件
├── docs/                  # 技术文档
├── tests/                 # 测试文件
├── config/                # 配置文件
│   ├── default.json      # 默认配置
│   └── .env.example      # 环境变量示例
├── logs/                  # 日志输出
├── .workspace/            # 工作空间（代码片段存储）
├── package.json
├── tsconfig.json
└── README.md
```

## 6. 开发路线图

### Phase 1: 基础设施 (Week 1)
- [ ] 项目初始化和依赖安装
- [ ] 配置系统实现
- [ ] 日志系统实现
- [ ] LLM 客户端抽象层

### Phase 2: 工具系统 (Week 2)
- [ ] 工具基类和接口定义
- [ ] 7 个标准工具实现
- [ ] 工具管理器和验证器
- [ ] 工具单元测试

### Phase 3: Agent 核心 (Week 3)
- [ ] Planner 实现
- [ ] Executor 实现
- [ ] Reflector 实现
- [ ] 状态管理器
- [ ] 主循环控制器

### Phase 4: CLI 界面 (Week 4)
- [ ] 命令行参数解析
- [ ] 交互式提示
- [ ] 进度可视化
- [ ] 用户确认机制

### Phase 5: 集成测试 (Week 5)
- [ ] 端到端测试
- [ ] 性能优化
- [ ] 错误处理完善
- [ ] 文档完善

## 7. 设计原则

### 7.1 模块化
- 每个模块职责单一，接口清晰
- 通过依赖注入实现松耦合
- 便于单元测试和功能扩展

### 7.2 可配置性
- 所有关键参数可通过配置文件调整
- 支持环境变量覆盖
- 多模型配置灵活切换

### 7.3 可观测性
- 完整的日志记录（输入/输出/工具调用）
- 实时进度显示
- 执行报告生成

### 7.4 安全性
- 工具调用前验证参数
- 危险操作需用户确认
- 文件操作限制在工作目录内

### 7.5 用户体验
- 清晰的命令行界面
- 友好的错误提示
- 可中断和恢复执行

## 8. 关键技术决策

### 8.1 为什么选择 TypeScript？
- 类型安全，减少运行时错误
- 优秀的 IDE 支持
- 丰富的生态系统

### 8.2 为什么使用多 Agent 架构？
- Planner/Executor/Reflector 职责分离
- 不同角色可使用不同模型（成本优化）
- 便于调试和优化单个环节

### 8.3 为什么需要反思循环？
- 自动发现执行问题
- 迭代改进任务质量
- 减少人工干预

### 8.4 为什么需要用户确认？
- 保证系统可控性
- 避免误操作
- 增强用户信任

## 9. 性能指标

### 9.1 响应时间
- Planner 规划: < 10s
- 单个工具调用: < 5s
- Reflector 评估: < 8s

### 9.2 准确性
- 工具调用成功率: > 95%
- 任务完成率: > 85%
- 反思有效性: > 80%

### 9.3 成本控制
- 平均每任务 Token 消耗: < 50K
- 支持使用小模型降低成本
- 缓存机制减少重复调用

## 10. 扩展性考虑

### 10.1 工具扩展
- 标准化工具接口
- 插件式工具注册
- 支持自定义工具

### 10.2 模型扩展
- 抽象 LLM 客户端接口
- 支持本地模型（Ollama）
- 支持多模态模型

### 10.3 存储扩展
- 支持数据库存储（SQLite/PostgreSQL）
- 支持向量数据库（代码语义检索）
- 支持云存储（S3/OSS）
