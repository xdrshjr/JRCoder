# 01-核心数据结构与接口

## 1. 消息协议

### 1.1 消息类型定义

```typescript
// 消息角色
type MessageRole = 'system' | 'user' | 'assistant' | 'tool';

// 基础消息结构
interface Message {
  role: MessageRole;
  content: string;
  timestamp: number;
  metadata?: Record<string, any>;
}

// 工具调用消息
interface ToolCallMessage extends Message {
  role: 'assistant';
  toolCalls: ToolCall[];
}

// 工具结果消息
interface ToolResultMessage extends Message {
  role: 'tool';
  toolCallId: string;
  toolName: string;
  result: any;
  error?: string;
}
```

### 1.2 对话历史

```typescript
interface Conversation {
  id: string;
  messages: Message[];
  createdAt: number;
  updatedAt: number;
}

class ConversationManager {
  addMessage(message: Message): void;
  getMessages(filter?: MessageFilter): Message[];
  clear(): void;
  export(): string; // 导出为 JSON
}
```

## 2. 任务与计划

### 2.1 任务定义

```typescript
// 任务状态
type TaskStatus = 'pending' | 'in_progress' | 'completed' | 'failed' | 'blocked';

// 单个任务
interface Task {
  id: string;
  title: string;
  description: string;
  status: TaskStatus;
  priority: number; // 1-5
  dependencies: string[]; // 依赖的任务 ID
  createdAt: number;
  updatedAt: number;
  result?: any;
  error?: string;
}

// 任务计划
interface Plan {
  id: string;
  goal: string; // 总体目标
  tasks: Task[];
  currentTaskId?: string;
  createdAt: number;
  updatedAt: number;
}
```

### 2.2 计划管理器

```typescript
class PlanManager {
  createPlan(goal: string, tasks: Task[]): Plan;
  updateTask(taskId: string, updates: Partial<Task>): void;
  getNextTask(): Task | null;
  isCompleted(): boolean;
  getProgress(): { completed: number; total: number; percentage: number };
}
```

## 3. 工具系统

### 3.1 工具接口

```typescript
// 工具参数定义
interface ToolParameter {
  name: string;
  type: 'string' | 'number' | 'boolean' | 'object' | 'array';
  description: string;
  required: boolean;
  default?: any;
  enum?: any[]; // 枚举值
}

// 工具定义
interface ToolDefinition {
  name: string;
  description: string;
  parameters: ToolParameter[];
  dangerous?: boolean; // 是否需要用户确认
}

// 工具调用
interface ToolCall {
  id: string;
  name: string;
  arguments: Record<string, any>;
}

// 工具结果
interface ToolResult {
  success: boolean;
  data?: any;
  error?: string;
  metadata?: {
    executionTime: number;
    tokensUsed?: number;
  };
}
```

### 3.2 工具基类

```typescript
abstract class BaseTool {
  abstract name: string;
  abstract description: string;
  abstract parameters: ToolParameter[];

  // 执行工具
  abstract execute(args: Record<string, any>): Promise<ToolResult>;

  // 验证参数
  validate(args: Record<string, any>): { valid: boolean; errors: string[] };

  // 获取工具定义（用于 LLM）
  getDefinition(): ToolDefinition;
}
```

## 4. Agent 状态

### 4.1 执行状态

```typescript
// Agent 执行阶段
type AgentPhase = 'planning' | 'executing' | 'reflecting' | 'confirming' | 'completed' | 'failed';

// Agent 状态
interface AgentState {
  phase: AgentPhase;
  plan?: Plan;
  conversation: Conversation;
  currentIteration: number;
  maxIterations: number;
  startTime: number;
  endTime?: number;
  metadata: {
    totalTokens: number;
    totalCost: number;
    toolCallsCount: number;
  };
}
```

### 4.2 状态管理器

```typescript
class StateManager {
  private state: AgentState;

  getState(): AgentState;
  updatePhase(phase: AgentPhase): void;
  setPlan(plan: Plan): void;
  incrementIteration(): void;
  addMessage(message: Message): void;
  updateMetadata(updates: Partial<AgentState['metadata']>): void;

  // 状态持久化
  save(path: string): Promise<void>;
  load(path: string): Promise<AgentState>;
}
```

## 5. LLM 客户端

### 5.1 LLM 配置

```typescript
interface LLMConfig {
  provider: 'openai' | 'anthropic' | 'ollama';
  model: string;
  apiKey?: string;
  baseURL?: string;
  temperature?: number;
  maxTokens?: number;
  topP?: number;
  timeout?: number;
}
```

### 5.2 LLM 请求与响应

```typescript
// LLM 请求
interface LLMRequest {
  messages: Message[];
  tools?: ToolDefinition[];
  temperature?: number;
  maxTokens?: number;
  stream?: boolean;
}

// LLM 响应
interface LLMResponse {
  content: string;
  toolCalls?: ToolCall[];
  finishReason: 'stop' | 'length' | 'tool_calls' | 'error';
  usage: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
}
```

### 5.3 LLM 客户端接口

```typescript
interface ILLMClient {
  chat(request: LLMRequest): Promise<LLMResponse>;
  chatStream(request: LLMRequest): AsyncGenerator<string>;
  estimateCost(tokens: number): number;
}

abstract class BaseLLMClient implements ILLMClient {
  protected config: LLMConfig;

  constructor(config: LLMConfig);

  abstract chat(request: LLMRequest): Promise<LLMResponse>;
  abstract chatStream(request: LLMRequest): AsyncGenerator<string>;
  abstract estimateCost(tokens: number): number;
}
```

## 6. 配置系统

### 6.1 全局配置

```typescript
interface GlobalConfig {
  // Agent 配置
  agent: {
    maxIterations: number;
    enableReflection: boolean;
    requireConfirmation: boolean;
  };

  // LLM 配置
  llm: {
    planner: LLMConfig;
    executor: LLMConfig;
    reflector: LLMConfig;
  };

  // 工具配置
  tools: {
    enabled: string[]; // 启用的工具列表
    workspaceDir: string;
    maxFileSize: number;
    allowedExtensions: string[];
  };

  // 日志配置
  logging: {
    level: 'debug' | 'info' | 'warn' | 'error';
    outputDir: string;
    enableConsole: boolean;
    enableFile: boolean;
  };

  // CLI 配置
  cli: {
    theme: 'light' | 'dark';
    showProgress: boolean;
    confirmDangerous: boolean;
  };
}
```

### 6.2 配置加载器

```typescript
class ConfigLoader {
  // 加载配置（优先级：CLI 参数 > 环境变量 > 配置文件 > 默认值）
  static load(configPath?: string): GlobalConfig;

  // 验证配置
  static validate(config: GlobalConfig): { valid: boolean; errors: string[] };

  // 合并配置
  static merge(base: GlobalConfig, override: Partial<GlobalConfig>): GlobalConfig;
}
```

## 7. 日志系统

### 7.1 日志级别与格式

```typescript
type LogLevel = 'debug' | 'info' | 'warn' | 'error';

interface LogEntry {
  level: LogLevel;
  message: string;
  timestamp: number;
  context?: {
    phase?: AgentPhase;
    iteration?: number;
    toolName?: string;
  };
  data?: any;
}
```

### 7.2 日志记录器

```typescript
interface ILogger {
  debug(message: string, data?: any): void;
  info(message: string, data?: any): void;
  warn(message: string, data?: any): void;
  error(message: string, error?: Error, data?: any): void;

  // 特殊日志方法
  logToolCall(toolName: string, args: any): void;
  logToolResult(toolName: string, result: ToolResult): void;
  logLLMRequest(request: LLMRequest): void;
  logLLMResponse(response: LLMResponse): void;
}

class Logger implements ILogger {
  constructor(config: GlobalConfig['logging']);

  // 实现所有接口方法
  // ...

  // 创建子日志器（带上下文）
  child(context: Record<string, any>): Logger;
}
```

## 8. 存储系统

### 8.1 代码片段存储

```typescript
interface CodeSnippet {
  id: string;
  name: string;
  description: string;
  language: string;
  code: string;
  tags: string[];
  createdAt: number;
  updatedAt: number;
}

interface ISnippetStorage {
  save(snippet: CodeSnippet): Promise<void>;
  load(id: string): Promise<CodeSnippet | null>;
  list(filter?: { tags?: string[]; language?: string }): Promise<CodeSnippet[]>;
  delete(id: string): Promise<void>;
  search(query: string): Promise<CodeSnippet[]>;
}
```

### 8.2 会话存储

```typescript
interface SessionData {
  id: string;
  state: AgentState;
  config: GlobalConfig;
  createdAt: number;
  updatedAt: number;
}

interface ISessionStorage {
  save(session: SessionData): Promise<void>;
  load(id: string): Promise<SessionData | null>;
  list(): Promise<SessionData[]>;
  delete(id: string): Promise<void>;
}
```

## 9. 错误处理

### 9.1 错误类型

```typescript
// 基础错误类
class AgentError extends Error {
  constructor(
    message: string,
    public code: string,
    public details?: any
  ) {
    super(message);
    this.name = 'AgentError';
  }
}

// 具体错误类型
class ToolExecutionError extends AgentError {
  constructor(toolName: string, message: string, details?: any) {
    super(`Tool '${toolName}' execution failed: ${message}`, 'TOOL_ERROR', details);
  }
}

class LLMError extends AgentError {
  constructor(message: string, details?: any) {
    super(`LLM error: ${message}`, 'LLM_ERROR', details);
  }
}

class ConfigError extends AgentError {
  constructor(message: string, details?: any) {
    super(`Configuration error: ${message}`, 'CONFIG_ERROR', details);
  }
}

class ValidationError extends AgentError {
  constructor(message: string, details?: any) {
    super(`Validation error: ${message}`, 'VALIDATION_ERROR', details);
  }
}
```

### 9.2 错误处理器

```typescript
class ErrorHandler {
  // 处理错误并返回用户友好的消息
  static handle(error: Error): { message: string; recoverable: boolean };

  // 记录错误
  static log(error: Error, logger: ILogger): void;

  // 判断是否可恢复
  static isRecoverable(error: Error): boolean;
}
```

## 10. 事件系统

### 10.1 事件定义

```typescript
type EventType =
  | 'phase_changed'
  | 'task_started'
  | 'task_completed'
  | 'tool_called'
  | 'tool_completed'
  | 'iteration_started'
  | 'iteration_completed'
  | 'error_occurred'
  | 'user_confirmation_required';

interface AgentEvent {
  type: EventType;
  timestamp: number;
  data: any;
}
```

### 10.2 事件发射器

```typescript
type EventListener = (event: AgentEvent) => void;

class EventEmitter {
  private listeners: Map<EventType, EventListener[]>;

  on(eventType: EventType, listener: EventListener): void;
  off(eventType: EventType, listener: EventListener): void;
  emit(event: AgentEvent): void;
  once(eventType: EventType, listener: EventListener): void;
}
```

## 11. 类型工具

### 11.1 常用类型别名

```typescript
// 异步函数类型
type AsyncFunction<T = any> = (...args: any[]) => Promise<T>;

// 可选字段
type Optional<T, K extends keyof T> = Omit<T, K> & Partial<Pick<T, K>>;

// 深度部分类型
type DeepPartial<T> = {
  [P in keyof T]?: T[P] extends object ? DeepPartial<T[P]> : T[P];
};

// JSON 值类型
type JSONValue = string | number | boolean | null | JSONObject | JSONArray;
interface JSONObject { [key: string]: JSONValue; }
interface JSONArray extends Array<JSONValue> {}
```

### 11.2 类型守卫

```typescript
// 检查是否为工具调用消息
function isToolCallMessage(message: Message): message is ToolCallMessage {
  return message.role === 'assistant' && 'toolCalls' in message;
}

// 检查是否为工具结果消息
function isToolResultMessage(message: Message): message is ToolResultMessage {
  return message.role === 'tool';
}

// 检查是否为错误
function isAgentError(error: any): error is AgentError {
  return error instanceof AgentError;
}
```

## 12. 常量定义

```typescript
// 默认值
export const DEFAULT_MAX_ITERATIONS = 10;
export const DEFAULT_TEMPERATURE = 0.7;
export const DEFAULT_MAX_TOKENS = 4096;
export const DEFAULT_WORKSPACE_DIR = '.workspace';
export const DEFAULT_LOG_DIR = 'logs';

// 限制
export const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
export const MAX_CONVERSATION_LENGTH = 100;
export const MAX_TOOL_EXECUTION_TIME = 60000; // 60s

// 工具名称
export const TOOL_NAMES = {
  CODE_QUERY: 'code_query',
  FILE_READ: 'file_read',
  FILE_WRITE: 'file_write',
  FILE_LIST: 'file_list',
  SNIPPET_SAVE: 'snippet_save',
  SNIPPET_LOAD: 'snippet_load',
  SNIPPET_LIST: 'snippet_list',
  SHELL_EXEC: 'shell_exec',
  ASK_USER: 'ask_user',
} as const;
```

## 13. 接口使用示例

### 13.1 创建 Agent 状态

```typescript
const stateManager = new StateManager();
stateManager.updatePhase('planning');

const plan: Plan = {
  id: generateId(),
  goal: '实现用户登录功能',
  tasks: [
    { id: '1', title: '创建登录表单', status: 'pending', ... },
    { id: '2', title: '实现登录 API', status: 'pending', ... },
  ],
  createdAt: Date.now(),
  updatedAt: Date.now(),
};

stateManager.setPlan(plan);
```

### 13.2 调用工具

```typescript
const tool = new FileReadTool();
const result = await tool.execute({ path: 'src/index.ts' });

if (result.success) {
  console.log('File content:', result.data);
} else {
  console.error('Error:', result.error);
}
```

### 13.3 LLM 调用

```typescript
const client = new OpenAIClient(config.llm.planner);
const response = await client.chat({
  messages: conversation.messages,
  tools: toolManager.getDefinitions(),
  temperature: 0.7,
});

if (response.toolCalls) {
  // 处理工具调用
  for (const toolCall of response.toolCalls) {
    const result = await toolManager.execute(toolCall);
    // ...
  }
}
```
